<html lang="es">

<head>
    <title>Tres en Raya - Final</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
</head>

<body>
    <h2>Tres en Raya</h2>
    <canvas id="webglcanvas" style="border: none;" width="500" height="500"></canvas>

    <script id="vs" type="vertex">
        #version 300 es
        uniform mat4 uMatrizProyeccion;
        uniform mat4 uMatrizModelo;
        layout(location = 0) in vec2 aVertices;
        void main() {
            gl_Position = uMatrizProyeccion * uMatrizModelo * vec4(aVertices, 0.0, 1.0);
        }
    </script>

    <script id="fs" type="fragment">
        #version 300 es
        precision mediump float;
        uniform vec4 uColor;
        out vec4 color;
        void main() {
            color = uColor;
        }
    </script>

    <script>
        function identidad(r) { r[0] = 1; r[4] = 0; r[8] = 0; r[12] = 0; r[1] = 0; r[5] = 1; r[9] = 0; r[13] = 0; r[2] = 0; r[6] = 0; r[10] = 1; r[14] = 0; r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1 }
        function traslacion(matriz, tx, ty, tz) { var r = new Array(16); r[0] = 1; r[4] = 0; r[8] = 0; r[12] = tx; r[1] = 0; r[5] = 1; r[9] = 0; r[13] = ty; r[2] = 0; r[6] = 0; r[10] = 1; r[14] = tz; r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1; multiplica(matriz, matriz, r) }
        function ortho(r, izq, der, abj, arr, cerca, lejos) { r[0] = 2 / (der - izq); r[4] = 0; r[8] = 0; r[12] = -(der + izq) / (der - izq); r[1] = 0; r[5] = 2 / (arr - abj); r[9] = 0; r[13] = -(arr + abj) / (arr - abj); r[2] = 0; r[6] = 0; r[10] = -2 / (lejos - cerca); r[14] = -(lejos + cerca) / (lejos - cerca); r[3] = 0; r[7] = 0; r[11] = 0; r[15] = 1 }
        function multiplica(c, a, b) { let r = new Array(16); let i, j, k; for (i = 0; i < 4; i++) { for (j = 0; j < 4; j++) { let s = 0; for (k = 0; k < 4; k++)s = s + a[i + k * 4] * b[k + j * 4]; r[i + j * 4] = s } } for (i = 0; i < 16; i++)c[i] = r[i] }

        var MatrizProyeccion = new Array(16);
        var MatrizModelo = new Array(16);
        var uMatrizProyeccion, uMatrizModelo, uColor;
        var gl, canvas;
        var circuloVAO, tableroVAO;

        var piezas = [];
        var turnoRojo = true;
        var juegoTerminado = false;
        var tableroLogico = [[null, null, null], [null, null, null], [null, null, null]];

        function coordsAIndice(x, y) {
            const val = 4.0 / 3.0;
            const col = Math.round(x / val) + 1;
            const row = Math.round(-y / val) + 1;
            return { row, col };
        }

        function verificarGanador() {
            const t = tableroLogico;
            for (let i = 0; i < 3; i++) {
                if (t[i][0] && t[i][0] === t[i][1] && t[i][0] === t[i][2]) return t[i][0];
                if (t[0][i] && t[0][i] === t[1][i] && t[0][i] === t[2][i]) return t[0][i];
            }
            if (t[0][0] && t[0][0] === t[1][1] && t[0][0] === t[2][2]) return t[0][0];
            if (t[0][2] && t[0][2] === t[1][1] && t[0][2] === t[2][0]) return t[0][2];
            if (piezas.length === 9) return 'Empate';
            return null;
        }

        function dibujaTablero() {
            identidad(MatrizModelo);
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.uniform4f(uColor, 1.0, 1.0, 1.0, 1.0);
            gl.bindVertexArray(tableroVAO);
            gl.drawArrays(gl.LINES, 0, 8);
            gl.bindVertexArray(null);
        }

        function mouseDown(e) {
            if (juegoTerminado) return;

            const rect = canvas.getBoundingClientRect();
            const clickX = e.clientX - rect.left;
            const clickY = e.clientY - rect.top;
            const x = (clickX / canvas.width) * 4 - 2;
            const y = -(clickY / canvas.height) * 4 + 2;

            const limite = 2.0 / 3.0;
            let snappedX, snappedY;

            if (x < -limite) snappedX = -2 * limite;
            else if (x > limite) snappedX = 2 * limite;
            else snappedX = 0;

            if (y > limite) snappedY = 2 * limite;
            else if (y < -limite) snappedY = -2 * limite;
            else snappedY = 0;

            let celdaOcupada = piezas.some(p => Math.abs(p.x - snappedX) < 0.01 && Math.abs(p.y - snappedY) < 0.01);

            if (!celdaOcupada) {
                const jugadorActual = turnoRojo ? 'R' : 'A';
                const colorActual = turnoRojo ? [1.0, 0.0, 0.0] : [0.0, 0.0, 1.0];
                piezas.push({ x: snappedX, y: snappedY, color: colorActual });

                const { row, col } = coordsAIndice(snappedX, snappedY);
                tableroLogico[row][col] = jugadorActual;

                const ganador = verificarGanador();
                if (ganador) {
                    juegoTerminado = true;
                    setTimeout(() => {
                        if (ganador === 'Empate') {
                            alert('¡Es un empate!');
                        } else {
                            alert(`¡Ha ganado el jugador ${ganador === 'R' ? 'Rojo' : 'Azul'}!`);
                        }
                    }, 100);
                }

                turnoRojo = !turnoRojo;
            }
        }

        function dibujaCirculo(color, trasX, trasY) {
            identidad(MatrizModelo);
            traslacion(MatrizModelo, trasX, trasY, 0);
            gl.uniformMatrix4fv(uMatrizModelo, false, MatrizModelo);
            gl.uniform4f(uColor, color[0], color[1], color[2], 1.0);
            gl.bindVertexArray(circuloVAO);
            gl.drawArrays(gl.TRIANGLE_FAN, 1, 361);
            gl.bindVertexArray(null);
        }

        function render() {
            gl.clearColor(0.0, 0.0, 0.0, 1.0);
            gl.clear(gl.COLOR_BUFFER_BIT);
            dibujaTablero();
            for (const pieza of piezas) {
                dibujaCirculo(pieza.color, pieza.x, pieza.y);
            }
            requestAnimationFrame(render);
        }

        function main() {
            canvas = document.getElementById("webglcanvas");
            gl = canvas.getContext("webgl2");
            gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
            canvas.addEventListener("mousedown", mouseDown, false);

            var shaderDeVertice = gl.createShader(gl.VERTEX_SHADER); gl.shaderSource(shaderDeVertice, document.getElementById("vs").text.trim()); gl.compileShader(shaderDeVertice); var shaderDeFragmento = gl.createShader(gl.FRAGMENT_SHADER); gl.shaderSource(shaderDeFragmento, document.getElementById("fs").text.trim()); gl.compileShader(shaderDeFragmento); var programaID = gl.createProgram(); gl.attachShader(programaID, shaderDeVertice); gl.attachShader(programaID, shaderDeFragmento); gl.linkProgram(programaID); gl.useProgram(programaID);

            var verticesCirculo = [0.0, 0.0]; var radio = 0.5; for (var i = 0; i <= 360; i++) { var angulo = i * Math.PI / 180; verticesCirculo.push(radio * Math.cos(angulo), radio * Math.sin(angulo)) }
            circuloVAO = gl.createVertexArray(); gl.bindVertexArray(circuloVAO); var bufferCirculo = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, bufferCirculo); gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(verticesCirculo), gl.STATIC_DRAW); gl.enableVertexAttribArray(0); gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

            const c = 2.0 / 3.0; const verticesTablero = [-c, 2.0, -c, -2.0, c, 2.0, c, -2.0, -2.0, c, 2.0, c, -2.0, -c, 2.0, -c];
            tableroVAO = gl.createVertexArray(); gl.bindVertexArray(tableroVAO); var bufferTablero = gl.createBuffer(); gl.bindBuffer(gl.ARRAY_BUFFER, bufferTablero); gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(verticesTablero), gl.STATIC_DRAW); gl.enableVertexAttribArray(0); gl.vertexAttribPointer(0, 2, gl.FLOAT, false, 0, 0);

            gl.bindVertexArray(null); gl.bindBuffer(gl.ARRAY_BUFFER, null); uColor = gl.getUniformLocation(programaID, "uColor"); uMatrizProyeccion = gl.getUniformLocation(programaID, "uMatrizProyeccion"); uMatrizModelo = gl.getUniformLocation(programaID, "uMatrizModelo"); ortho(MatrizProyeccion, -2, 2, -2, 2, -1, 1); gl.uniformMatrix4fv(uMatrizProyeccion, false, MatrizProyeccion);

            requestAnimationFrame(render);
        }
        window.onload = main;
    </script>
</body>

</html>
